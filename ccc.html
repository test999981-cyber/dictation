<!DOCTYPE html><html lang="zh-HK"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»˜æ›¸ App (è‡ªå‹•èªè¨€ç‰ˆ)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f7;
            color: #333;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative; /* For absolute positioning if needed */
        }
        h1, h2, h3 {
            text-align: center;
            color: #007aff;
            margin-top: 0;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .hidden {
            display: none;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input, textarea, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background-color: #007aff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }
        /* Secondary buttons (Grey) */
        button.secondary {
            background-color: #e5e5ea;
            color: #333;
        }
        button.secondary:hover {
            background-color: #d1d1d6;
        }
        /* Primary Action Button (Green) */
        button.primary-action {
            background-color: #34c759; 
            font-size: 1.1em;
        }
        button.primary-action:hover {
            background-color: #28a745;
        }

        /* Back Button (Top Left) */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .btn-back {
            background: none;
            color: #007aff;
            border: none;
            width: auto;
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            margin: 0;
        }
        .btn-back:hover {
            background: #f0f0f5;
            text-decoration: underline;
        }

        .status-msg {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        .error-msg {
            color: #ff3b30;
            font-weight: bold;
        }
        
        /* Display Area */
        .player-display-container {
            position: relative;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 15px 0;
            padding: 20px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .player-text {
            font-size: 3.0em;
            text-align: center;
            white-space: pre-wrap;
            font-weight: 500;
        }
        .lang-badge {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 10px;
            background: #eee;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .toggle-btn {
            background: transparent;
            border: 1px solid #ccc;
            color: #555;
            width: auto;
            margin-top: 10px;
            font-size: 0.9em;
            padding: 5px 15px;
        }
        .toggle-btn:hover {
            background: #eee;
        }

        .controls {
            display: flex;
            gap: 10px;
        }
        .controls button {
            flex: 1;
        }
        #debugInfo {
            font-size: 12px;
            color: #999;
            white-space: pre-wrap;
            margin-top: 10px;
            display: none;
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script></head>
<body>

<div class="container">
    
    <!-- Setup Section -->
    <div id="setupSection">
        <h1>é»˜æ›¸ App</h1>
        <div class="section">
            <h2>è¨­å®šé»˜æ›¸å…§å®¹</h2>
            
            <!-- User Dropdown -->
            <label for="userSelect">é¸æ“‡ä½¿ç”¨è€…</label>
            <select id="userSelect" onchange="handleUserChange()">
                <option value="12RmFsfmrO7GgQPnw-YUvjgIt41SPut8K0qSK_GOAj74" selected="">Alfred</option>
                <option value="15u9NKmyAY06MLgH_-O7iUbnLMM2VlpuGsE3_H76a1ss">Max</option>
            </select>
    
            <label>Google Sheet é€£çµ (æˆ– ID)</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="sheetUrlInput" placeholder="è²¼ä¸Š Google Sheet ID æˆ– URL">
                <button type="button" onclick="loadFromInput()" style="width:auto;">è²¼ä¸Š</button>
                <!-- æ–°å¢çš„é–‹å•Ÿ Sheet æŒ‰éˆ• -->
                <button type="button" onclick="openGoogleSheet()" style="width:auto; background-color: #5856d6;">é–‹å•Ÿ Sheet</button>
            </div>
            
            <div id="loadingStatus" class="status-msg"></div>
            <div id="errorMessage" class="status-msg error-msg"></div>
    
            <label for="topicSelect">èª²é¡Œé¸é … (ä¾†è‡ªç¬¬ä¸€è¡Œ)</label>
            <select id="topicSelect" disabled="">
                <option value="">è«‹å…ˆè¼‰å…¥æ•¸æ“š...</option>
            </select>
    
            <label for="manualContent">é»˜æ›¸å…§å®¹ (æ¯è¡Œä¸€å¥)</label>
            <textarea id="manualContent" rows="5" placeholder="åœ¨æ­¤è¼¸å…¥æˆ–å¾ Sheet è¼‰å…¥..."></textarea>
    
            <button onclick="startDictation()">é–‹å§‹é»˜æ›¸</button>
            
            <div id="debugInfo">èª¿è©¦ä¿¡æ¯ï¼š</div>
        </div>
    </div>

    <!-- Player Section -->
    <div id="playerSection" class="hidden">
        <!-- Top Bar with Back Button -->
        <div class="top-bar">
            <button class="btn-back" onclick="stopDictation()">â® çµæŸé»˜æ›¸</button>
            <div style="font-weight:bold; color:#007aff;">æ­£åœ¨é»˜æ›¸</div>
            <div style="width: 80px;"></div> <!-- Spacer for centering -->
        </div>
        
        <div class="section">
            <h3>æ’­æ”¾è¨­å®š</h3>
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>æ’­æ”¾é€Ÿåº¦</label>
                    <select id="rateSelect">
                        <option value="0.1">0.1x</option>
                        <option value="0.2">0.2x</option>
                        <option value="0.4">0.4x</option>
                        <option value="0.6" selected="">0.6x (é è¨­)</option>
                        <option value="0.8">0.8x</option>
                        <option value="1.0">1.0x</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label>é‡è¤‡æ¬¡æ•¸</label>
                    <select id="repeatSelect">
                        <option value="1">1æ¬¡</option>
                        <option value="2">2æ¬¡</option>
                        <option value="3">3æ¬¡</option>
                    </select>
                </div>
            </div>

            <label>
                <input type="checkbox" id="punctuationCheck" style="width:auto;"> æœ—è®€æ¨™é»ç¬¦è™Ÿ
            </label>
        </div>

        <div class="section">
            <div style="text-align:center; color:#666; margin-bottom:5px;">
                é€²åº¦ï¼š<span id="currentIndex">0</span> / <span id="totalIndex">0</span>
            </div>
            
            <div class="player-display-container">
                <div id="detectedLang" class="lang-badge">è‡ªå‹•åµæ¸¬ä¸­...</div>
                <div class="player-text" id="displayArea">æº–å‚™é–‹å§‹...</div>
                <button class="toggle-btn" onclick="toggleContent()">ğŸ‘ï¸ é¡¯ç¤º/éš±è—å…§å®¹</button>
            </div>

            <div class="controls">
                <button class="secondary" onclick="prevLine()">ä¸Šä¸€è¡Œ</button>
                <button class="secondary" onclick="replayLine()">é‡æ’­</button>
                <button class="primary-action" onclick="nextLine()">ä¸‹ä¸€è¡Œ</button>
            </div>
        </div>
    </div>
</div>

<script>
    // State variables
    let sheetData = {}; 
    let currentLines = [];
    let currentLineIndex = 0;
    let synth = window.speechSynthesis;
    let isContentHidden = true; // Default to hidden

    // Initialize
    window.onload = function() {
        handleUserChange();
        // Ensure voices are loaded
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = function() {
                console.log("Voices loaded");
            };
        }
    };

    // --- Data Loading Logic ---

    function handleUserChange() {
        const select = document.getElementById('userSelect');
        const selectedId = select.value;
        document.getElementById('sheetUrlInput').value = selectedId;
        fetchSheetData(selectedId);
    }

    function loadFromInput() {
        const input = document.getElementById('sheetUrlInput').value.trim();
        let id = input;
        if (input.includes('/d/')) {
            const matches = input.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (matches && matches[1]) {
                id = matches[1];
            }
        }
        fetchSheetData(id);
    }

    // æ–°å¢åŠŸèƒ½ï¼šé–‹å•Ÿ Google Sheet
    function openGoogleSheet() {
        const input = document.getElementById('sheetUrlInput').value.trim();
        if (!input) {
            alert("è«‹å…ˆè¼¸å…¥ Google Sheet ID æˆ– URL");
            return;
        }
        
        let url = input;
        // å¦‚æœè¼¸å…¥çš„åªæ˜¯ ID (ä¸åŒ…å« http)ï¼Œå‰‡çµ„åˆæˆå®Œæ•´ URL
        if (!input.startsWith('http')) {
            url = `https://docs.google.com/spreadsheets/d/${input}/edit`;
        }
        
        window.open(url, '_blank');
    }

    function fetchSheetData(sheetId) {
        if (!sheetId) return;

        const status = document.getElementById('loadingStatus');
        const errorDiv = document.getElementById('errorMessage');
        const debug = document.getElementById('debugInfo');
        
        status.innerText = "æ­£åœ¨å¾Google Sheetè¼‰å…¥æ•¸æ“š...";
        errorDiv.innerText = "";
        debug.innerText = "èª¿è©¦ä¿¡æ¯ï¼šæ­£åœ¨è«‹æ±‚ " + sheetId;

        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error("Network response was not ok");
                return response.text();
            })
            .then(csvText => {
                parseCSV(csvText);
                status.innerText = "è¼‰å…¥æˆåŠŸ";
            })
            .catch(err => {
                console.error(err);
                status.innerText = "";
                errorDiv.innerText = "éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥æ•¸æ“šï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ– IDã€‚";
                debug.innerText += "\nFetch Error: " + err.message;
            });
    }

    // --- CSV Parsing Logic ---
    function parseCSV(text) {
        sheetData = {};
        const lines = text.split(/\r?\n/); 
        
        if (lines.length < 1) {
             document.getElementById('errorMessage').innerText = "éŒ¯èª¤ï¼šCSV å…§å®¹ç‚ºç©º";
             return;
        }

        const headerLine = lines[0];
        const headers = parseCSVLine(headerLine);
        
        headers.forEach(header => {
            let topicName = cleanCSVValue(header);
            if (topicName) {
                sheetData[topicName] = [];
            }
        });

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            if (!line.trim()) continue;

            const cols = parseCSVLine(line);

            cols.forEach((cellValue, colIndex) => {
                if (colIndex < headers.length) {
                    const topicName = cleanCSVValue(headers[colIndex]);
                    const content = cleanCSVValue(cellValue);

                    if (topicName && content) {
                        sheetData[topicName].push(content);
                    }
                }
            });
        }

        updateTopicDropdown();
    }

    function parseCSVLine(line) {
        const result = [];
        let startValueIndex = 0;
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            if (line[i] === '"') {
                inQuotes = !inQuotes;
            } else if (line[i] === ',' && !inQuotes) {
                let val = line.substring(startValueIndex, i);
                result.push(val);
                startValueIndex = i + 1;
            }
        }
        let val = line.substring(startValueIndex);
        result.push(val);
        return result;
    }

    function cleanCSVValue(val) {
        if (!val) return "";
        val = val.trim();
        if (val.startsWith('"') && val.endsWith('"')) {
            val = val.slice(1, -1);
            val = val.replace(/""/g, '"');
        }
        return val;
    }

    function updateTopicDropdown() {
        const select = document.getElementById('topicSelect');
        select.innerHTML = '';
        const topics = Object.keys(sheetData);
        
        if (topics.length === 0) {
            const option = document.createElement('option');
            option.text = "ç„¡æ•¸æ“š";
            select.add(option);
            select.disabled = true;
            return;
        }

        topics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            option.text = topic + ` (${sheetData[topic].length}å¥)`;
            select.add(option);
        });
        
        select.disabled = false;
        if (topics.length > 0) {
            select.value = topics[0];
            fillManualContent(topics[0]);
        }
        select.onchange = () => fillManualContent(select.value);
    }

    function fillManualContent(topic) {
        const content = sheetData[topic] || [];
        document.getElementById('manualContent').value = content.join('\n');
    }

    // --- Playback Logic ---

    function startDictation() {
        const text = document.getElementById('manualContent').value;
        if (!text.trim()) {
            alert("è«‹å…ˆè¼¸å…¥æˆ–è¼‰å…¥é»˜æ›¸å…§å®¹");
            return;
        }

        currentLines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        if (currentLines.length === 0) return;

        currentLineIndex = 0;
        isContentHidden = true; // Reset to hidden on start
        document.getElementById('totalIndex').innerText = currentLines.length;
        
        document.getElementById('setupSection').classList.add('hidden');
        document.getElementById('playerSection').classList.remove('hidden');
        
        updateDisplay();
        speakCurrentLine();
    }

    function stopDictation() {
        synth.cancel();
        document.getElementById('playerSection').classList.add('hidden');
        document.getElementById('setupSection').classList.remove('hidden');
    }

    function toggleContent() {
        isContentHidden = !isContentHidden;
        updateDisplay();
    }

    function updateDisplay() {
        document.getElementById('currentIndex').innerText = currentLineIndex + 1;
        
        const originalText = currentLines[currentLineIndex];
        const displayArea = document.getElementById('displayArea');
        
        // Auto detect language for display badge
        const isChinese = /[\u4e00-\u9fa5]/.test(originalText);
        const langText = isChinese ? "ç²µèª" : "è‹±èª (UK)";
        document.getElementById('detectedLang').innerText = "èªè¨€: " + langText;

        if (isContentHidden) {
            // Replace non-whitespace characters with *
            // This preserves spaces so user knows word count for English
            displayArea.innerText = originalText.replace(/[^\s]/g, '*');
        } else {
            displayArea.innerText = originalText;
        }
    }

    function prevLine() {
        if (currentLineIndex > 0) {
            currentLineIndex--;
            isContentHidden = true; // Hide again when moving
            updateDisplay();
            speakCurrentLine();
        }
    }

    function nextLine() {
        if (currentLineIndex < currentLines.length - 1) {
            currentLineIndex++;
            isContentHidden = true; // Hide again when moving
            updateDisplay();
            speakCurrentLine();
        } else {
            document.getElementById('displayArea').innerText = "é»˜æ›¸çµæŸ";
            document.getElementById('detectedLang').innerText = "";
            synth.cancel();
        }
    }

    function replayLine() {
        speakCurrentLine();
    }

    function speakCurrentLine() {
        synth.cancel();

        const text = currentLines[currentLineIndex];
        const repeatCount = parseInt(document.getElementById('repeatSelect').value);
        const rate = parseFloat(document.getElementById('rateSelect').value);
        
        // Auto Detect Language
        // If contains Chinese characters -> zh-HK, else -> en-GB
        const isChinese = /[\u4e00-\u9fa5]/.test(text);
        const lang = isChinese ? 'zh-HK' : 'en-GB';

        playRepeat(text, repeatCount, 0, rate, lang);
    }

    function playRepeat(text, totalRepeats, currentRepeat, rate, lang) {
        if (currentRepeat >= totalRepeats) return;

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        utterance.rate = rate;
        
        const voices = synth.getVoices();
        if (lang === 'en-GB') {
            // Try to find Samantha or a GB voice
            // Note: Samantha is actually en-US on some systems but sounds good. 
            // Strict request was British English. Let's look for 'en-GB'.
            let voice = voices.find(v => v.lang === 'en-GB');
            // Fallback to Samantha if GB not found (common on Mac/iOS for good quality)
            if (!voice) voice = voices.find(v => v.name.includes('Samantha'));
            if (voice) utterance.voice = voice;
        } else if (lang === 'zh-HK') {
             const cantonese = voices.find(v => v.lang === 'zh-HK');
             if (cantonese) utterance.voice = cantonese;
        }

        utterance.onend = function() {
            if (currentRepeat < totalRepeats - 1) {
                setTimeout(() => {
                    playRepeat(text, totalRepeats, currentRepeat + 1, rate, lang);
                }, 500); 
            }
        };

        utterance.onerror = function(e) {
            console.error("Speech error", e);
        };

        synth.speak(utterance);
    }
</script>



</body></html>